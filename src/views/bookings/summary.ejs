<div class="summary-container">
    <div class="summary-header">
        <div class="header-icon">
            <i class="fas fa-clipboard-check"></i>
        </div>
        <h2>Resumen de tu Reserva</h2>
        <p class="lead text-muted">Revisa los detalles de tu estancia antes de continuar</p>
        <% if (user) { %>
            <p class="user-info">Reserva para: <strong><%= user.nombre %></strong></p>
        <% } %>
    </div>

    <div class="summary-content">
        <div class="summary-section">
            <h3><i class="fas fa-calendar-alt"></i> Fechas de Estancia</h3>
            <div class="detail-row">
                <div class="detail-group">
                    <span class="detail-label">Check-in</span>
                    <span id="summaryCheckIn" class="detail-value"></span>
                </div>
                <i class="fas fa-arrow-right text-muted"></i>
                <div class="detail-group">
                    <span class="detail-label">Check-out</span>
                    <span id="summaryCheckOut" class="detail-value"></span>
                </div>
            </div>
            <div class="detail-row">
                <span class="detail-label">Duración de la estancia</span>
                <span id="summaryNights" class="detail-value badge bg-primary"></span>
            </div>
        </div>

        <div class="summary-section">
            <h3><i class="fas fa-users"></i> Información de Huéspedes</h3>
            <div class="guests-grid">
                <div class="guest-type">
                    <i class="fas fa-user"></i>
                    <span class="detail-label">Adultos</span>
                    <span id="summaryAdults" class="detail-value"></span>
                </div>
                <div class="guest-type">
                    <i class="fas fa-child"></i>
                    <span class="detail-label">Niños</span>
                    <span id="summaryChildren" class="detail-value"></span>
                </div>
            </div>
        </div>

        <div class="summary-section pricing-section">
            <h3><i class="fas fa-euro-sign"></i> Desglose de Precios</h3>
            <div class="price-details">
                <div class="detail-row">
                    <span class="detail-label">Precio por noche</span>
                    <span class="detail-value">50€</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Número de noches</span>
                    <span id="nightsCount" class="detail-value"></span>
                </div>
                <div class="detail-row total">
                    <span class="detail-label">Total</span>
                    <span id="summaryTotalPrice" class="detail-value"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="payment-section">
        <h3><i class="fas fa-credit-card"></i> Método de Pago</h3>
        <p class="text-muted mb-4">Selecciona tu método de pago preferido para completar la reserva</p>
        <div class="payment-options">
            <div id="paypal-button-container"></div>
        </div>
    </div>
</div>

<style>
.summary-container {
    max-width: 800px;
    margin: 40px auto;
    padding: 40px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 15px 30px rgba(0,0,0,0.1);
}

.summary-header {
    text-align: center;
    margin-bottom: 50px;
}

.header-icon {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
}

.summary-section {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
    transition: all 0.3s ease;
}

.summary-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #e9ecef;
}

.detail-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: #212529;
}

.guests-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-top: 20px;
}

.guest-type {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 20px;
    background: white;
    border-radius: 10px;
    gap: 10px;
}

.guest-type i {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.pricing-section {
    background: linear-gradient(145deg, #f8f9fa, #ffffff);
}

.detail-row.total {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid var(--primary-color);
}

.detail-row.total .detail-value {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.payment-section {
    margin-top: 50px;
    text-align: center;
}

.payment-options {
    max-width: 500px;
    margin: 0 auto;
    padding: 30px;
    background: #f8f9fa;
    border-radius: 15px;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.05);
}

@media (max-width: 768px) {
    .summary-container {
        margin: 20px;
        padding: 20px;
    }

    .guests-grid {
        grid-template-columns: 1fr;
    }

    .detail-row {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookingData = JSON.parse(sessionStorage.getItem('bookingData'));
    const pricePerNight = 50;

    if (bookingData) {
        // Formatear las fechas en español
        const formatearFecha = (fechaStr) => {
            const [dia, mes, año] = fechaStr.split('/');
            const fecha = new Date(año, mes - 1, dia);
            return fecha.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        };

        // Mostrar los datos en la página
        document.getElementById('summaryCheckIn').textContent = formatearFecha(bookingData.checkIn);
        document.getElementById('summaryCheckOut').textContent = formatearFecha(bookingData.checkOut);
        document.getElementById('summaryNights').textContent = `${bookingData.nights} noches`;
        document.getElementById('nightsCount').textContent = bookingData.nights;
        document.getElementById('summaryAdults').textContent = bookingData.adults;
        document.getElementById('summaryChildren').textContent = bookingData.children;
        
        // Calcular el precio total
        const totalPrice = pricePerNight * parseInt(bookingData.nights);
        document.getElementById('summaryTotalPrice').textContent = `${totalPrice}€`;

        // Configuración del botón de PayPal
        paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: totalPrice.toString(),
                            currency_code: 'EUR'
                        },
                        description: `Reserva de ${bookingData.nights} noches`
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    // Convertir las fechas al formato ISO para la base de datos
                    const [day, month, year] = bookingData.checkIn.split('/');
                    const checkInDate = `${year}-${month}-${day}`;
                    
                    const [dayOut, monthOut, yearOut] = bookingData.checkOut.split('/');
                    const checkOutDate = `${yearOut}-${monthOut}-${dayOut}`;
                    
                    // Preparar los datos para enviar al servidor
                    const serverData = {
                        checkIn: checkInDate,
                        checkOut: checkOutDate,
                        nights: bookingData.nights,
                        adults: bookingData.adults,
                        children: bookingData.children,
                        totalPrice: parseFloat(totalPrice.toString()),
                        paymentDetails: details
                    };

                    // Enviar los datos al servidor después del pago exitoso
                    return fetch('/reservas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(serverData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '/reservas/pago-exitoso';
                        } else {
                            throw new Error(data.error || 'Error al guardar la reserva');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al procesar la reserva');
                        window.location.href = '/reservas/pago-fallido';
                    });
                });
            },
            onError: function(err) {
                console.error('Error en el pago:', err);
                alert('Ha ocurrido un error durante el proceso de pago. Por favor, inténtalo de nuevo.');
                window.location.href = '/reservas/pago-fallido';
            }
        }).render('#paypal-button-container');
    }
});
</script>

<!-- Scripts necesarios -->
<script src="https://www.paypal.com/sdk/js?client-id=<%= process.env.PAYPAL_CLIENT_ID %>&currency=EUR&components=buttons"></script>
<script src="/js/booking-summary.js"></script>

.user-info {
    margin-top: 10px;
    color: var(--primary-color);
    font-size: 1.1rem;
}